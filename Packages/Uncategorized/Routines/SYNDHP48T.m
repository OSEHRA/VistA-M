SYNDHP48T ; OSE/SMH - Unit Testing For /MedicationStatement & Others;2019-11-05  10:35 AM
 ;;1.0;DHP;;Jan 17, 2017;Build 46
 ;
 ; (c) 2019 OSEHRA
 ; 
 ; Licensed under the Apache License, Version 2.0 (the "License");
 ; you may not use this file except in compliance with the License.
 ; You may obtain a copy of the License at
 ; 
 ; http://www.apache.org/licenses/LICENSE-2.0
 ; 
 ; Unless required by applicable law or agreed to in writing, software
 ; distributed under the License is distributed on an "AS IS" BASIS,
 ; WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 ; See the License for the specific language governing permissions and
 ; limitations under the License.
 ;
 ;
 ;
TEST ; [Unit Test Runner]
 D EN^%ut($T(+0),3)
 QUIT
SHUTDOWN ;
 ; ZEXCEPT:ICNOP,ICNIP
 ; ZEXCEPT:EFFY1,EFFY2,EFFY3,EFFYM1,EFFYM2,EFFYMD1,EFFYMD2
 K ICNOP,ICNIP
 K EFFY1,EFFY2,EFFY3,EFFYM1,EFFYM2,EFFYMD1,EFFYMD2
 QUIT
 ; ZEXCEPT:HTTPERR,FRDAT,TODAT,RETSTA,HTTPARGS
SETUP    K HTTPERR,FRDAT,TODAT,RETSTA,HTTPARGS QUIT
 ; ZEXCEPT:HTTPERR,FRDAT,TODAT,RETSTA,HTTPARGS
TEARDOWN K HTTPERR,FRDAT,TODAT,RETSTA,HTTPARGS QUIT
 ;
T1 ;
 N ICN S ICN=""
 F  S ICN=$O(^DPT("AFICN",ICN)) Q:ICN=""  D
 .W !!!,ICN,!!!
 .D PATMEDA^SYNDHP48(.RETSTA,ICN)
 .W $$ZW^SYNDHPUTL("RETSTA")
 .W !!!
 Q
 ;
T2 ;
 N RETSTA
 N ICN S ICN=""
 F  S ICN=$O(^DPT("AFICN",ICN)) Q:ICN=""  D
 .W !,ICN,!
 .D PATMEDD^SYNDHP48(.RETSTA,ICN)
 .W $$ZW^SYNDHPUTL("RETSTA"),!!
 Q
 ;
T3 ;
 N RETSTA
 N ICN,XPIEN
 S ICN=""
 F  S ICN=$O(^DPT("AFICN",ICN)) Q:ICN=""  D
 .S XPIEN=$O(^DPT("AFICN",ICN,""))
 .W !,ICN,!,XPIEN,!,^DPT(XPIEN,0),!
 .D PATMEDS^SYNDHP48(.RETSTA,ICN)
 .W $$ZW^SYNDHPUTL("RETSTA"),!!
 Q
 ;
T4 ;
 N ICN S ICN="5000000341V359724"
 N FRDAT S FRDAT=""
 N TODAT S TODAT=""
 N RETSTA
 D PATMEDA^SYNDHP48(.RETSTA,ICN,FRDAT,TODAT)
 W $$ZW^SYNDHPUTL("RETSTA"),!!
 QUIT
 ;
T5 ;
 N ICN S ICN="5000000341V359724"
 N FRDAT S FRDAT=20100101
 N TODAT S TODAT=20150101
 N RETSTA
 D PATMEDA^SYNDHP48(.RETSTA,ICN,FRDAT,TODAT)
 W $$ZW^SYNDHPUTL("RETSTA"),!!
 QUIT
 ;
T6 ;
 N ICN S ICN="5000000341V359724"
 N FRDAT S FRDAT=""
 N TODAT S TODAT=""
 N RETSTA
 D PATMEDD^SYNDHP48(.RETSTA,ICN,FRDAT,TODAT)
 W $$ZW^SYNDHPUTL("RETSTA"),!!
 QUIT
 ;
T7 ;
 N ICN S ICN="5000000341V359724"
 N FRDAT S FRDAT=20100101
 N TODAT S TODAT=20150101
 N RETSTA
 D PATMEDD^SYNDHP48(.RETSTA,ICN,FRDAT,TODAT)
 W $$ZW^SYNDHPUTL("RETSTA"),!!
 QUIT
 ;
T8 ;
 N ICN S ICN="5000000341V359724"
 N FRDAT S FRDAT=""
 N TODAT S TODAT=""
 N RETSTA
 D PATMEDS^SYNDHP48(.RETSTA,ICN,FRDAT,TODAT)
 W $$ZW^SYNDHPUTL("RETSTA"),!!
 QUIT
 ;
T9 ;
 N ICN S ICN="5000000341V359724"
 N FRDAT S FRDAT=20100101
 N TODAT S TODAT=20150101
 N RETSTA
 D PATMEDS^SYNDHP48(.RETSTA,ICN,FRDAT,TODAT)
 W $$ZW^SYNDHPUTL("RETSTA"),!!
 QUIT
 ;
T10 ; @TEST Test Outpatient Medications Get by ICN
 ; ZEXCEPT:ICNOP,ICNIP
 N RETSTA
 D PATMEDS^SYNDHP48(.RETSTA,ICNOP)
 D ZWRITE^SYNDHPUTL(RETSTA)
 D CHKEQ^%ut(@RETSTA@(1),ICNOP_U)
 D CHKTF^%ut($O(@RETSTA@(""),-1)>1)
 QUIT
 ;
T11 ; @TEST Test Inpatient Medications Get by ICN
 ; ZEXCEPT:ICNOP,ICNIP
 N RETSTA
 D PATMEDS^SYNDHP48(.RETSTA,ICNIP)
 D ZWRITE^SYNDHPUTL(RETSTA)
 D CHKEQ^%ut(@RETSTA@(1),ICNIP_U)
 D CHKTF^%ut($O(@RETSTA@(""),-1)>1)
 QUIT
 ;
T12 ; @TEST Test Medications Get by ?patient
 ; ZEXCEPT:ICNOP,ICNIP
 N HTTPARGS S HTTPARGS("patient")=ICNIP
 N RETSTA
 D PATMEDS^SYNDHP48(.RETSTA)
 D CHKEQ^%ut(@RETSTA@(1),ICNIP_U)
 D CHKTF^%ut($O(@RETSTA@(""),-1)>1)
 QUIT
 ;
T13 ; @TEST Test ?_id outpatient med
 ; ZEXCEPT:ICNOP,ICNIP
 N HTTPARGS S HTTPARGS("_id")="V-999-52-2151"
 N RETSTA
 D PATMEDS^SYNDHP48(.RETSTA)
 D CHKEQ^%ut(@RETSTA@(1),ICNOP_U)
 D CHKTF^%ut($O(@RETSTA@(""),-1)=2)
 QUIT
 ;
T14 ; @TEST Test ?_id inpatient med
 ; ZEXCEPT:ICNOP,ICNIP
 N HTTPARGS S HTTPARGS("_id")="V-999-55-17-55.06-3"
 N RETSTA
 D PATMEDS^SYNDHP48(.RETSTA)
 D CHKEQ^%ut(@RETSTA@(1),ICNIP_U)
 D CHKTF^%ut($O(@RETSTA@(""),-1)=2)
 QUIT
 ;
T15 ; @TEST Test bad ICN
 N HTTPARGS S HTTPARGS("patient")="888V222"
 N RETSTA
 D PATMEDS^SYNDHP48(.RETSTA)
 D CHKTF^%ut(RETSTA<0)
 QUIT
 ;
T16 ; @TEST Test bad ID
 N HTTPARGS S HTTPARGS("_id")="V-999-55-17-55.06-322222"
 N RETSTA
 D PATMEDS^SYNDHP48(.RETSTA)
 ; ZEXCEPT: HTTPERR
 D CHKTF^%ut(HTTPERR=400)
 QUIT
 ;
T17 ; @TEST Test Status: Active
 ; ZEXCEPT: ICNIP,ICNOP
 N HTTPARGS
 S HTTPARGS("patient")=ICNIP
 S HTTPARGS("status")="active"
 N RETSTA
 D PATMEDS^SYNDHP48(.RETSTA)
 D CHKEQ^%ut(@RETSTA@(1),ICNIP_U)
 W !
 D ZWRITE^SYNDHPUTL(RETSTA)
 S HTTPARGS("patient")=ICNOP
 S HTTPARGS("status")="active"
 D PATMEDS^SYNDHP48(.RETSTA)
 D CHKEQ^%ut(@RETSTA@(1),ICNOP_U)
 D ZWRITE^SYNDHPUTL(RETSTA)
 QUIT
 ;
T18 ; @TEST Test Status: Completed = EXPIRED
 ; ZEXCEPT: ICNIP,ICNOP
 N HTTPARGS
 S HTTPARGS("patient")=ICNIP
 S HTTPARGS("status")="completed"
 N RETSTA
 D PATMEDS^SYNDHP48(.RETSTA)
 D CHKEQ^%ut(@RETSTA@(1),ICNIP_U)
 W !
 D ZWRITE^SYNDHPUTL(RETSTA)
 S HTTPARGS("patient")=ICNOP
 S HTTPARGS("status")="completed"
 D PATMEDS^SYNDHP48(.RETSTA)
 D CHKEQ^%ut(@RETSTA@(1),ICNOP_U)
 D ZWRITE^SYNDHPUTL(RETSTA)
 QUIT
 ;
T19 ; @TEST Test Status: Entered in error (= deleted in outpatient)
 ; ZEXCEPT: ICNIP,ICNOP
 N HTTPARGS
 S HTTPARGS("patient")=ICNOP
 S HTTPARGS("status")="entered-in-error"
 N RETSTA
 D PATMEDS^SYNDHP48(.RETSTA)
 D CHKEQ^%ut(@RETSTA@(1),ICNOP_U)
 W !
 D ZWRITE^SYNDHPUTL(RETSTA)
 QUIT
 ;
T20 ; @TEST Test Status: Stopped = DISCONTINUED
 ; ZEXCEPT: ICNIP,ICNOP
 N HTTPARGS
 S HTTPARGS("patient")=ICNIP
 S HTTPARGS("status")="stopped"
 N RETSTA
 D PATMEDS^SYNDHP48(.RETSTA)
 D CHKEQ^%ut(@RETSTA@(1),ICNIP_U)
 W !
 D ZWRITE^SYNDHPUTL(RETSTA)
 S HTTPARGS("patient")=ICNOP
 S HTTPARGS("status")="stopped"
 D PATMEDS^SYNDHP48(.RETSTA)
 D CHKEQ^%ut(@RETSTA@(1),ICNOP_U)
 D ZWRITE^SYNDHPUTL(RETSTA)
 QUIT
 ;
T21 ; @TEST Test Status: on-hold = HOLD
 ; ZEXCEPT: ICNIP,ICNOP
 N HTTPARGS
 S HTTPARGS("patient")=ICNIP
 S HTTPARGS("status")="on-hold"
 N RETSTA
 D PATMEDS^SYNDHP48(.RETSTA)
 D CHKEQ^%ut(@RETSTA@(1),ICNIP_U)
 W !
 D ZWRITE^SYNDHPUTL(RETSTA)
 S HTTPARGS("patient")=ICNOP
 S HTTPARGS("status")="on-hold"
 D PATMEDS^SYNDHP48(.RETSTA)
 D CHKEQ^%ut(@RETSTA@(1),ICNOP_U)
 D ZWRITE^SYNDHPUTL(RETSTA)
 QUIT
 ;
T22 ; @TEST Test Status: not-taken (unreleased meds in outpatient)
 ; ZEXCEPT: ICNIP,ICNOP
 N HTTPARGS
 S HTTPARGS("patient")=ICNOP
 S HTTPARGS("status")="not-taken"
 N RETSTA
 D PATMEDS^SYNDHP48(.RETSTA)
 D CHKEQ^%ut(@RETSTA@(1),ICNOP_U)
 W ! D ZWRITE^SYNDHPUTL(RETSTA)
 QUIT
 ;
STARTUP ; [Constants] Modify to suit your system so tests would pass.
 ; ZEXCEPT:ICNOP,ICNIP
 ; ZEXCEPT:EFFY1,EFFY2,EFFY3,EFFYM1,EFFYM2,EFFYMD1,EFFYMD2
 S ICNOP="2421492932V802082"
 S ICNIP="9990000005V380966"
 S EFFY1=2007
 S EFFYM1="2007-11"
 S EFFYMD1="2007-11-20"
 S EFFY2=2019
 S EFFYM2="2019-10"
 S EFFYMD2="2019-10-16"
 S EFFY3=1954
 QUIT
 ;
T23 ; @TEST Test Effective Date - inexact year
 ; ZEXCEPT: ICNIP,ICNOP,EFFY1,EFFY2,EFFY3
 N HTTPARGS
 S HTTPARGS("patient")=ICNOP
 S HTTPARGS("effective")=EFFY1
 N RETSTA
 D PATMEDS^SYNDHP48(.RETSTA)
 D CHKEQ^%ut(@RETSTA@(1),ICNOP_U)
 N I F I=1:1 S I=$O(@RETSTA@(I)) Q:'I  D
 . N DATES S DATES=$P(@RETSTA@(I),U,4)
 . N SDATE S SDATE=$P(DATES,";",2)
 . D tf^%ut(SDATE[EFFY1)
 S HTTPARGS("patient")=ICNIP
 S HTTPARGS("effective")=EFFY2
 D PATMEDS^SYNDHP48(.RETSTA)
 D CHKEQ^%ut(@RETSTA@(1),ICNIP_U)
 N I F I=1:1 S I=$O(@RETSTA@(I)) Q:'I  D
 . N DATES S DATES=$P(@RETSTA@(I),U,4)
 . N SDATE S SDATE=$P(DATES,";",2)
 . D tf^%ut(SDATE[EFFY2)
 S HTTPARGS("patient")=ICNIP
 S HTTPARGS("effective")=EFFY3
 D PATMEDS^SYNDHP48(.RETSTA)
 D tf^%ut('$D(@RETSTA@(2)))
 QUIT
T24 ; @TEST Test Effective Date - inexact year/month
 ; ZEXCEPT: ICNIP,ICNOP,EFFYM1,EFFYM2
 N HTTPARGS
 S HTTPARGS("patient")=ICNOP
 S HTTPARGS("effective")=EFFYM1
 N RETSTA
 D PATMEDS^SYNDHP48(.RETSTA)
 N I F I=1:1 S I=$O(@RETSTA@(I)) Q:'I  D
 . N DATES S DATES=$P(@RETSTA@(I),U,4)
 . N SDATE S SDATE=$P(DATES,";",2)
 . D tf^%ut(SDATE[$tr(EFFYM1,"-"))
 S HTTPARGS("patient")=ICNIP
 S HTTPARGS("effective")=EFFYM2
 D PATMEDS^SYNDHP48(.RETSTA)
 N I F I=1:1 S I=$O(@RETSTA@(I)) Q:'I  D
 . N DATES S DATES=$P(@RETSTA@(I),U,4)
 . N SDATE S SDATE=$P(DATES,";",2)
 . D tf^%ut(SDATE[$tr(EFFYM2,"-"))
 QUIT
T25 ; @TEST Test Effective Date - exact
 ; ZEXCEPT: ICNIP,ICNOP,EFFYMD1,EFFYMD2
 N HTTPARGS
 S HTTPARGS("patient")=ICNOP
 S HTTPARGS("effective")=EFFYMD1
 N RETSTA
 D PATMEDS^SYNDHP48(.RETSTA)
 N I F I=1:1 S I=$O(@RETSTA@(I)) Q:'I  D
 . N DATES S DATES=$P(@RETSTA@(I),U,4)
 . N SDATE S SDATE=$P(DATES,";",2)
 . D tf^%ut(SDATE[$tr(EFFYMD1,"-"))
 S HTTPARGS("patient")=ICNIP
 S HTTPARGS("effective")=EFFYMD2
 D PATMEDS^SYNDHP48(.RETSTA)
 N I F I=1:1 S I=$O(@RETSTA@(I)) Q:'I  D
 . N DATES S DATES=$P(@RETSTA@(I),U,4)
 . N SDATE S SDATE=$P(DATES,";",2)
 . D tf^%ut(SDATE[$tr(EFFYMD2,"-"))
 QUIT
T26 ; @TEST Test Effective Date - eqdate
 ; ZEXCEPT: ICNIP,ICNOP,EFFYMD1,EFFYMD2
 N HTTPARGS
 S HTTPARGS("patient")=ICNOP
 S HTTPARGS("effective")="eq"_EFFYMD1
 N RETSTA
 D PATMEDS^SYNDHP48(.RETSTA)
 N I F I=1:1 S I=$O(@RETSTA@(I)) Q:'I  D
 . N DATES S DATES=$P(@RETSTA@(I),U,4)
 . N SDATE S SDATE=$P(DATES,";",2)
 . D tf^%ut(SDATE[$tr(EFFYMD1,"-"))
 S HTTPARGS("patient")=ICNIP
 S HTTPARGS("effective")="eq"_EFFYMD2
 D PATMEDS^SYNDHP48(.RETSTA)
 N I F I=1:1 S I=$O(@RETSTA@(I)) Q:'I  D
 . N DATES S DATES=$P(@RETSTA@(I),U,4)
 . N SDATE S SDATE=$P(DATES,";",2)
 . D tf^%ut(SDATE[$tr(EFFYMD2,"-"))
 QUIT
T27 ; @TEST Test Effective Date - nedate
 ; ZEXCEPT: ICNIP,ICNOP,EFFYMD1,EFFYMD2
 N HTTPARGS
 S HTTPARGS("patient")=ICNOP
 S HTTPARGS("effective")="ne"_EFFYMD1
 N RETSTA
 D PATMEDS^SYNDHP48(.RETSTA)
 ;W ! D ZWRITE^SYNDHPUTL(RETSTA)
 N I F I=1:1 S I=$O(@RETSTA@(I)) Q:'I  D
 . N DATES S DATES=$P(@RETSTA@(I),U,4)
 . N SDATE S SDATE=$P(DATES,";",2)
 . D tf^%ut(SDATE'[$tr(EFFYMD1,"-"))
 S HTTPARGS("patient")=ICNIP
 S HTTPARGS("effective")="ne"_EFFYMD2
 D PATMEDS^SYNDHP48(.RETSTA)
 ;W ! D ZWRITE^SYNDHPUTL(RETSTA)
 N I F I=1:1 S I=$O(@RETSTA@(I)) Q:'I  D
 . N DATES S DATES=$P(@RETSTA@(I),U,4)
 . N SDATE S SDATE=$P(DATES,";",2)
 . D tf^%ut(SDATE'[$tr(EFFYMD2,"-"))
 QUIT
T28 ; @TEST Test Effective Date - ltdate
 ; ZEXCEPT: ICNIP,ICNOP,EFFYMD1,EFFYMD2
 N HTTPARGS
 S HTTPARGS("patient")=ICNOP
 S HTTPARGS("effective")="lt"_EFFYMD1
 N RETSTA
 D PATMEDS^SYNDHP48(.RETSTA)
 ;W ! D ZWRITE^SYNDHPUTL(RETSTA)
 N I F I=1:1 S I=$O(@RETSTA@(I)) Q:'I  D
 . N DATES S DATES=$P(@RETSTA@(I),U,4)
 . N SDATE S SDATE=$P(DATES,";",2)
 . D tf^%ut($E(SDATE,1,8)<$tr(EFFYMD1,"-"))
 S HTTPARGS("patient")=ICNIP
 S HTTPARGS("effective")="lt"_EFFYMD2
 D PATMEDS^SYNDHP48(.RETSTA)
 ;W ! D ZWRITE^SYNDHPUTL(RETSTA)
 N I F I=1:1 S I=$O(@RETSTA@(I)) Q:'I  D
 . N DATES S DATES=$P(@RETSTA@(I),U,4)
 . N SDATE S SDATE=$P(DATES,";",2)
 . D tf^%ut($E(SDATE,1,8)<$tr(EFFYMD2,"-"))
 QUIT
T29 ; @TEST Test Effective Date - gtdate
 ; ZEXCEPT: ICNIP,ICNOP,EFFYMD1,EFFYMD2
 N HTTPARGS
 S HTTPARGS("patient")=ICNOP
 S HTTPARGS("effective")="gt"_EFFYMD1
 N RETSTA
 D PATMEDS^SYNDHP48(.RETSTA)
 ;W ! D ZWRITE^SYNDHPUTL(RETSTA)
 N I F I=1:1 S I=$O(@RETSTA@(I)) Q:'I  D
 . N DATES S DATES=$P(@RETSTA@(I),U,4)
 . N SDATE S SDATE=$P(DATES,";",2)
 . D tf^%ut($E(SDATE,1,8)>$tr(EFFYMD1,"-"))
 S HTTPARGS("patient")=ICNIP
 S HTTPARGS("effective")="gt"_EFFYMD2
 D PATMEDS^SYNDHP48(.RETSTA)
 ;W ! D ZWRITE^SYNDHPUTL(RETSTA)
 N I F I=1:1 S I=$O(@RETSTA@(I)) Q:'I  D
 . N DATES S DATES=$P(@RETSTA@(I),U,4)
 . N SDATE S SDATE=$P(DATES,";",2)
 . D tf^%ut($E(SDATE,1,8)>$tr(EFFYMD2,"-"))
 QUIT
T30 ; @TEST Test Effective Date - ledate
 ; ZEXCEPT: ICNIP,ICNOP,EFFYMD1,EFFYMD2
 N HTTPARGS
 S HTTPARGS("patient")=ICNOP
 S HTTPARGS("effective")="le"_EFFYMD1
 N RETSTA
 D PATMEDS^SYNDHP48(.RETSTA)
 ;W ! D ZWRITE^SYNDHPUTL(RETSTA)
 N I F I=1:1 S I=$O(@RETSTA@(I)) Q:'I  D
 . N DATES S DATES=$P(@RETSTA@(I),U,4)
 . N SDATE S SDATE=$P(DATES,";",2)
 . D tf^%ut($E(SDATE,1,8)'>$tr(EFFYMD1,"-"))
 S HTTPARGS("patient")=ICNIP
 S HTTPARGS("effective")="le"_EFFYMD2
 D PATMEDS^SYNDHP48(.RETSTA)
 ;W ! D ZWRITE^SYNDHPUTL(RETSTA)
 N I F I=1:1 S I=$O(@RETSTA@(I)) Q:'I  D
 . N DATES S DATES=$P(@RETSTA@(I),U,4)
 . N SDATE S SDATE=$P(DATES,";",2)
 . D tf^%ut($E(SDATE,1,8)'>$tr(EFFYMD2,"-"))
 QUIT
T31 ; @TEST Test Effective Date - gedate
 ; ZEXCEPT: ICNIP,ICNOP,EFFYMD1,EFFYMD2
 N HTTPARGS
 S HTTPARGS("patient")=ICNOP
 S HTTPARGS("effective")="ge"_EFFYMD1
 N RETSTA
 D PATMEDS^SYNDHP48(.RETSTA)
 ;W ! D ZWRITE^SYNDHPUTL(RETSTA)
 N I F I=1:1 S I=$O(@RETSTA@(I)) Q:'I  D
 . N DATES S DATES=$P(@RETSTA@(I),U,4)
 . N SDATE S SDATE=$P(DATES,";",2)
 . D tf^%ut($E(SDATE,1,8)'<$tr(EFFYMD1,"-"))
 S HTTPARGS("patient")=ICNIP
 S HTTPARGS("effective")="ge"_EFFYMD2
 D PATMEDS^SYNDHP48(.RETSTA)
 ;W ! D ZWRITE^SYNDHPUTL(RETSTA)
 N I F I=1:1 S I=$O(@RETSTA@(I)) Q:'I  D
 . N DATES S DATES=$P(@RETSTA@(I),U,4)
 . N SDATE S SDATE=$P(DATES,";",2)
 . D tf^%ut($E(SDATE,1,8)'<$tr(EFFYMD2,"-"))
 QUIT
T32 ; @TEST Test Effective Date - apdate
 ; ZEXCEPT: ICNIP,ICNOP,EFFYMD1,EFFYMD2
 N HTTPARGS
 S HTTPARGS("patient")=ICNOP
 S HTTPARGS("effective")="ap"_EFFYMD1
 N RETSTA
 D PATMEDS^SYNDHP48(.RETSTA)
 W ! D ZWRITE^SYNDHPUTL(RETSTA)
 S HTTPARGS("patient")=ICNIP
 S HTTPARGS("effective")="ap"_EFFYMD2
 D PATMEDS^SYNDHP48(.RETSTA)
 W ! D ZWRITE^SYNDHPUTL(RETSTA)
 QUIT
